<style>
  /* Carte */
.card {
  border-radius: 8px;
  box-shadow: 0 0 8px rgb(0 0 0 / 0.1);
  transition: transform 0.2s ease-in-out;
}

.card:hover {
  transform: translateY(-5px);
}

/* Statut de la commande */
.card-status {
  padding: 0.3rem 0.6rem;
  border-radius: 0.5rem;
  font-weight: 600;
  text-transform: capitalize;
  font-size: 0.85rem;
  color: #fff;
}

/* Couleurs selon le statut */
.status-en-attente { background-color: #ffc107; }  /* jaune */
.status-en-cours { background-color: #0dcaf0; }   /* bleu clair */
.status-terminée { background-color: #198754; }   /* vert */
.status-annulée { background-color: #dc3545; }    /* rouge */
.status-livrée { background-color: #198754; }     /* vert */

/* Bouton détails */
.btn-details {
  background-color: transparent;
  border: none;
  color: white;
  font-size: 1.1rem;
  cursor: pointer;
  transition: color 0.2s ease-in-out;
}

.btn-details:hover {
  color: #ffc107;
}

/* Adresse tronquée (clicable) */
.adresse-tronquee {
  cursor: pointer;
  color: #0d6efd;
  text-decoration: underline;
  user-select: none;
}

/* Texte pour crédit en rouge si > 0 */
.credit-attention {
  color: #dc3545;
  font-weight: 700;
}

/* Icones créateur et livreur */
.info-creator i,
.info-delivery i {
  margin-right: 0.4rem;
  color: #6c757d;
}

/* Blocs de détails */
.info-block,
.products-block,
.payments-block {
  margin-bottom: 1rem;
}

.products-block ul,
.payments-block ul {
  margin-bottom: 0;
}

.payments-block li {
  font-size: 0.9rem;
  color: #6c757d;
}

</style>
<div class="container">
  <h2 class="text-center mb-4">Liste des Commandes</h2>

  <!-- Filtres -->
  <div class="row mb-4 justify-content-center g-3">
    <div class="col-12 col-md-4">
      <label for="search" class="form-label">Rechercher</label>
      <input
        id="search"
        type="text"
        class="form-control"
        placeholder="Par ID ou Client"
        [(ngModel)]="searchTerm"
      />
    </div>
    <div class="col-12 col-md-3">
      <label for="status" class="form-label">Statut</label>
      <select
        id="status"
        class="form-select"
      >
        <option value="">Tous</option>
        <option value="en attente">En attente</option>
        <option value="en cours">En cours</option>
        <option value="terminée">Terminée</option>
        <option value="annulée">Annulée</option>
        <option value="livrée">Livrée</option>
      </select>
    </div>
    <div class="col-12 col-md-3">
      <label for="date" class="form-label">Date</label>
      <input
        id="date"
        type="date"
        class="form-control"
      />
    </div>
  </div>

  <!-- Liste commandes -->
  <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
    <div class="col" *ngFor="let commande of filteredCommandes">
      <div class="card h-100 border-primary shadow-sm">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">Commande #{{ commande.id }}</h5>
          <div class="d-flex align-items-center gap-2">
            <span
              class="card-status"
              [ngClass]="'status-' + commande.status.replace(' ', '-')"
            >
              {{ commande.status }}
            </span>
            <button 
              type="button" 
              class="btn-details" 
              data-bs-toggle="modal" 
              data-bs-target="#detailsModal"
              (click)="selectedCommande = commande"
              title="Voir détails"
            >
              <i class="fas fa-eye"></i>
            </button>
            <button 
            *ngIf="commande.status !== 'livrée'"
            type="button" 
            class="btn-details" 
            data-bs-toggle="modal" 
            data-bs-target="#detailsModal"
            (click)="selectedCommande = commande"
            title="Attribuer un livreur"
          >
            <i class="fas fa-truck"></i>
          </button>
          
          </div>
        </div>
        <div class="card-body">
          <p><strong>Client :</strong> {{ commande.client_name }}</p>
          <p><strong>Téléphone :</strong> {{ commande.client_mobile }}</p>
          <p>
            <strong>Adresse :</strong>
            <span
              class="adresse-tronquee"
              data-bs-toggle="modal"
              data-bs-target="#adresseModal"
              (click)="adresseComplete = commande.client_adresse"
              title="Cliquer pour voir l'adresse complète"
            >
              {{ commande.client_adresse.length > 40 ? (commande.client_adresse | slice:0:40) + '...' : commande.client_adresse }}
            </span>
          </p>
          <p><strong>Date :</strong> {{ commande.created_at | date:'mediumDate' }}</p>
          <p><strong>Total :</strong> {{ commande.total }} DH</p>
          <p *ngIf="commande.credit_sur_commande" class="credit-attention">
            <strong>Crédit :</strong> {{ commande.credit_sur_commande | number:'1.2-2' }} DH
          </p>
          <p *ngIf="commande.creator_name" class="info-creator">
            <i class="fas fa-user"></i> Créé par : {{ commande.creator_name }}
          </p>
          <p *ngIf="commande.status.toLowerCase() === 'livrée' && commande.delivery_name" class="info-delivery">
            <i class="fas fa-truck"></i> Livré par : {{ commande.delivery_name }}
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Modals -->
  <div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="detailsModalLabel">Détails de la commande #{{ selectedCommande?.id }}</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
        </div>
        <div class="modal-body">
          <div class="row mb-3">
            <div class="col-md-6">
              <p><strong>Total :</strong> {{ selectedCommande?.total | number:'1.2-2' }} DH</p>
              <p *ngIf="selectedCommande?.credit_sur_commande" class="credit-attention">
                <strong>Crédit :</strong> {{ selectedCommande?.credit_sur_commande | number:'1.2-2' }} DH
              </p>
            </div>
            <div class="col-md-6">
              <p><strong>Statut :</strong>
                <span class="card-status status-{{ selectedCommande?.status.replace(' ', '-') }}">
                  {{ selectedCommande?.status }}
                </span>
              </p>
              <p *ngIf="selectedCommande?.creator_name" class="info-creator">
                <i class="fas fa-user me-2"></i> Créé par : {{ selectedCommande?.creator_name }}
              </p>
              <p *ngIf="selectedCommande?.status.toLowerCase() === 'livrée' && selectedCommande?.delivery_name" class="info-delivery">
                <i class="fas fa-truck me-2"></i> Livré par : {{ selectedCommande?.delivery_name }}
              </p>
            </div>
          </div>
  
          <!-- Produits -->
          <div class="mb-4">
            <h6 class="text-primary border-bottom pb-2 mb-3">Produits</h6>
            <div *ngIf="selectedCommande?.items?.length > 0; else noItems">
              <table class="table table-sm table-striped align-middle">
                <thead>
                  <tr>
                    <th>Produit</th>
                    <th class="text-end">Prix unitaire (DH)</th>
                    <th class="text-end">Remise (DH)</th>
                    <th class="text-center">Quantité</th>
                    <th class="text-end">Total ligne (DH)</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let item of selectedCommande?.items">
                    <td>{{ item.product_name }}</td>
                    <td class="text-end">{{ item.price | number:'1.2-2' }}</td>
                    <td class="text-end">{{ item.remise | number:'1.2-2' }}</td>
                    <td class="text-center">{{ item.quantity }}</td>
                    <td class="text-end">{{ item.total_ligne | number:'1.2-2' }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <ng-template #noItems>
              <p class="text-muted fst-italic">Aucun produit dans cette commande.</p>
            </ng-template>
          </div>
  
          <!-- Paiements -->
          <div>
            <h6 class="text-primary border-bottom pb-2 mb-3">Paiements</h6>
            <div *ngIf="selectedCommande?.paiements?.length > 0; else noPayments">
              <ul class="list-group list-group-flush">
                <li *ngFor="let paiement of selectedCommande?.paiements" class="list-group-item d-flex justify-content-between align-items-center px-0">
                  <span>{{ paiement.montant | number:'1.2-2' }} DH - {{ paiement.mode_paiement }}</span>
                  <small class="text-muted">{{ paiement.date_paiement | date:'mediumDate' }}</small>
                </li>
              </ul>
            </div>
            <ng-template #noPayments>
              <p class="text-muted fst-italic">Aucun paiement enregistré.</p>
            </ng-template>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
        </div>
      </div>
    </div>
  </div>
  
  

  <!-- Modal Bootstrap pour l'adresse complète -->
  <div class="modal fade" id="adresseModal" tabindex="-1" aria-labelledby="adresseModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="adresseModalLabel">Adresse complète</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
        </div>
        <div class="modal-body">
          <p>{{ adresseComplete }}</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
        </div>
      </div>
    </div>
  </div>
</div>


