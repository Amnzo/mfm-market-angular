<style>
  /* Carte */
.card {
  border-radius: 8px;
  box-shadow: 0 0 8px rgb(0 0 0 / 0.1);
  transition: transform 0.2s ease-in-out;
}

.card:hover {
  transform: translateY(-5px);
}

/* Statut de la commande */
.card-status {
  padding: 0.3rem 0.6rem;
  border-radius: 0.5rem;
  font-weight: 600;
  text-transform: capitalize;
  font-size: 0.85rem;
  color: #fff;
}

/* Couleurs selon le statut */
.status-en-attente { background-color: #8c888b; }  /* jaune */
.status-en-cours { background-color: #f00dd2; }   /* bleu clair */
.status-livrée { background-color: #198754; }     /* vert */
.status-annulée { background-color: #dc3545; }    /* rouge */


/* Bouton détails */
.btn-details {
  background-color: transparent;
  border: none;
  color: white;
  font-size: 1.1rem;
  cursor: pointer;
  transition: color 0.2s ease-in-out;
}

.btn-details:hover {
  color: #ffc107;
}

/* Adresse tronquée (clicable) */
.adresse-tronquee {
  cursor: pointer;
  color: #0d6efd;
  text-decoration: underline;
  user-select: none;
}

/* Texte pour crédit en rouge si > 0 */
.credit-attention {
  color: #dc3545;
  font-weight: 700;
}

/* Icones créateur et livreur */
.info-creator i,
.info-delivery i {
  margin-right: 0.4rem;
  color: #6c757d;
}

/* Blocs de détails */
.info-block,
.products-block,
.payments-block {
  margin-bottom: 1.5rem;
  padding: 1rem;
  background-color: #f8f9fa;
  border-radius: 8px;
}

.products-block ul,
.payments-block ul {
  margin-bottom: 0;
}

.payments-block li {
  font-size: 0.9rem;
  color: #6c757d;
}

.modal-content {
  border-radius: 1rem;
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
}

.modal-header {
  background-color: #0d6efd;
  color: white;
  padding: 1.5rem;
  border-radius: 1rem 1rem 0 0 !important;
}

.modal-title {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.modal-body {
  padding: 2rem;
}

.table thead th {
  background-color: #f8f9fa;
  font-weight: 600;
  color: #495057;
}

.table td {
  vertical-align: middle;
}

/* Paiements styles */
.paiements-section {
  background-color: white;
  border-radius: 8px;
  padding: 1.5rem;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.paiement-date {
  color: #6c757d;
  font-size: 0.9rem;
}

.paiement-amount {
  font-weight: 600;
  color: #212529;
}

.paiement-method {
  color: #6c757d;
  font-size: 0.9rem;
}

/* Statut styles */
.card-status {
  padding: 0.5rem 1rem;
  border-radius: 20px;
  font-weight: bold;
  display: inline-block;
  color: #fff;
  font-size: 0.9rem;
  min-width: 120px;
  text-align: center;
}

.status-livrée {
  background-color: #198754;
  color: white;
}

.status-en-cours {
  background-color: #ffc107;
  color: #000;
}

.status-annulée {
  background-color: #dc3545;
  color: white;
}

/* Footer styles */
.modal-footer {
  padding: 1rem;
  border-top: 1px solid #dee2e6;
  background-color: #f8f9fa;
}

.btn-close-white {
  filter: brightness(0) invert(1);
}

</style>
<div class="container">
  <app-menu></app-menu>
  <div class="container-fluid bg-light rounded-3 p-4 mb-4">
    <div class="row">
      <div class="col-12">
        <h2 class="mb-3">Liste des Commandes</h2>
      </div>
    </div>
    <div class="row">
      <div class="col-12">
        <div class="input-group mb-3">
          <span class="input-group-text bg-white border-end-0">
            <i class="fas fa-search"></i>
          </span>
          <input type="text" class="form-control border-start-0" placeholder="Rechercher par nom de client..." [(ngModel)]="searchTerm" (input)="applyFilters()">
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-12 col-md-6">
        <select class="form-select form-select-sm" [(ngModel)]="statusFilter" (change)="applyFilters()">
          <option value="">Tous les statuts</option>
          <option value="en attente">En attente</option>
          <option value="en cours">En cours</option>
          <option value="livrée">Livrée</option>
          <option value="annulée">Annulée</option>
        </select>
      </div>
      <div class="col-12 col-md-4">
        <input type="date" class="form-control form-control-sm" [(ngModel)]="dateFilter" (change)="applyFilters()">
      </div>
      <div class="col-12 col-md-2">
        <button class="btn btn-outline-primary btn-sm" (click)="creditFilter = !creditFilter; applyFilters()">
          <i class="fas fa-credit-card"></i>
          <span *ngIf="!creditFilter">Avec crédit</span>
          <span *ngIf="creditFilter">Tous</span>
        </button>
      </div>
    </div>
  </div>
  
  <!-- Liste commandes -->



  <!-- Liste commandes -->
  <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
    <div class="col" *ngFor="let commande of filteredCommandes">
      <div class="card h-100 border-primary shadow-sm">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">Commande #{{ commande.id }}</h5>
          <div class="d-flex align-items-center gap-2">
            <span
              class="card-status"
              [ngClass]="'status-' + commande.status.replace(' ', '-')"
            >
              {{ commande.status }}
            </span>
            <i *ngIf="commande.credit_sur_commande" class="fas fa-exclamation-triangle text-warning" title="Commande avec crédit"></i>
            <button 
              type="button" 
              class="btn-details" 
              data-bs-toggle="modal" 
              data-bs-target="#detailsModal"
              (click)="selectedCommande = commande"
              title="Voir détails"
            >
              <i class="fas fa-eye"></i>
            </button>
            <button 
              *ngIf="!commande.delivery_name"
              type="button" 
              class="btn-details" 
              data-bs-toggle="modal" 
              data-bs-target="#assignDeliveryModal"
              (click)="selectedCommande = commande"
              title="Attribuer un livreur"
            >
              <i class="fas fa-truck"></i>
            </button>
          
            <!-- Bouton Print -->
            <button 
              type="button"
              class="btn-details"
              (click)="imprimerCommande(commande)"
              title="Imprimer la commande"
            >
              <i class="fas fa-print"></i>
            </button>
          </div>

        </div>
        <div class="card-body">

          <p><strong>Client :</strong> {{ commande.client_name }}</p>
          <p><strong>Téléphone :</strong> {{ commande.client_mobile }}</p>
          <p>
            <strong>Adresse :</strong>
            <span
              class="adresse-tronquee"
              data-bs-toggle="modal"
              data-bs-target="#adresseModal"
              (click)="adresseComplete = commande.client_adresse"
              title="Cliquer pour voir l'adresse complète"
            >
              {{ commande.client_adresse.length > 40 ? (commande.client_adresse | slice:0:40) + '...' : commande.client_adresse }}
            </span>
          </p>
          <p><strong>Date :</strong> {{ commande.created_at | date:'mediumDate' }}</p>
          <p><strong>Total :</strong> {{ commande.total }} DH</p>

          <p *ngIf="commande.creator_name" class="info-creator">
            <i class="fas fa-user"></i> Créé par : {{ commande.creator_name }}
          </p>
          <p *ngIf="commande.status.toLowerCase() === 'livrée' && commande.delivery_name" class="info-delivery">
            <i class="fas fa-truck"></i> Livré par : {{ commande.delivery_name }}
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Modals -->
  <!-- Modals -->
<div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white rounded-top">
        <h5 class="modal-title" id="detailsModalLabel">
          <i class="fas fa-info-circle me-2"></i>Détails de la commande #{{ selectedCommande?.id }}
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body">
        <div class="row mb-4">
          <div class="col-md-6">
            <p><strong><i class="fas fa-user me-1"></i>Client :</strong> {{ selectedCommande?.client_name }}</p>
            <p><strong><i class="fas fa-phone me-1"></i>Téléphone :</strong> {{ selectedCommande?.client_mobile }}</p>
            <p><strong><i class="fas fa-map-marker-alt me-1"></i>Adresse :</strong> {{ selectedCommande?.client_adresse }}</p>
            <p><strong><i class="fas fa-calendar-alt me-1"></i>Date :</strong> {{ selectedCommande?.created_at | date:'medium' }}</p>
            <p><strong><i class="fas fa-coins me-1"></i>Total :</strong> {{ selectedCommande?.total | number:'1.2-2' }} DH</p>
            <div *ngIf="selectedCommande?.credit_sur_commande" class="alert alert-warning p-2 mb-3">
              <div class="d-flex align-items-center">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <div>
                  <strong>Crédit à suivre :</strong> 
                  <span class="credit-attention">{{ selectedCommande?.credit_sur_commande | number:'1.2-2' }} DH</span>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <p><strong><i class="fas fa-info-circle me-1"></i>Statut :</strong>
              <span class="card-status status-{{ selectedCommande?.status.replace(' ', '-').toLowerCase() }}">
                {{ selectedCommande?.status }}
              </span>
            </p>
            <p *ngIf="selectedCommande?.delivery_name" class="info-delivery">
              <i class="fas fa-truck me-2"></i>
              <span *ngIf="selectedCommande?.status.toLowerCase() === 'livrée'">Livré par :</span>
              <span *ngIf="selectedCommande?.status.toLowerCase() === 'en cours'">Attribué à :</span>
              {{ selectedCommande?.delivery_name }}
            </p>
          </div>
        </div>

        <!-- Produits -->
        <div class="mb-4">
          <h5 class="text-primary border-bottom pb-2 mb-3">
            <i class="fas fa-boxes me-2"></i>Produits
          </h5>
          <div class="table-responsive">
            <table class="table table-sm table-striped align-middle">
              <thead>
                <tr>
                  <th>Produit</th>
                  <th class="text-end">Prix unitaire</th>
                  <th class="text-end">Remise</th>
                  <th class="text-center">Quantité</th>
                  <th class="text-end">Total ligne</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of selectedCommande?.items">
                  <td>{{ item.product_name }}</td>
                  <td class="text-end">{{ item.price | number:'1.2-2' }} DH</td>
                  <td class="text-end">{{ item.remise | number:'1.2-2' }} %</td>
                  <td class="text-center">{{ item.quantity }}</td>
                  <td class="text-end">{{ item.total_ligne | number:'1.2-2' }} DH</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Paiements -->
        <div class="paiements-section">
          <h5 class="text-primary border-bottom pb-2 mb-3">
            <i class="fas fa-money-bill-wave me-2"></i>Paiements
          </h5>
          <div *ngIf="selectedCommande?.paiements?.length > 0; else noPayments">
            <div class="table-responsive">
              <table class="table table-sm table-striped align-middle">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th class="text-end">Montant</th>
                    <th>Mode de paiement</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let paiement of selectedCommande?.paiements">
                    <td class="paiement-date">
                      <i class="fas fa-calendar-alt me-1"></i>
                      {{ paiement.date_paiement | date:'medium' }}
                    </td>
                    <td class="text-end paiement-amount">
                      <i class="fas fa-money-bill-wave me-1"></i>
                      {{ paiement.montant | number:'1.2-2' }} DH
                    </td>
                    <td class="paiement-method">
                      <i class="fas fa-credit-card me-1"></i>
                      {{ paiement.mode_paiement }}
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <ng-template #noPayments>
            <div class="text-center py-4">
              <i class="fas fa-wallet fa-3x text-muted mb-3"></i>
              <p class="text-muted fst-italic mb-0">Aucun paiement enregistré.</p>
            </div>
          </ng-template>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times me-1"></i> Fermer
        </button>
      </div>
    </div>
  </div>
</div>

  

  <!-- Modal pour assigner un livreur -->
  <div class="modal fade" id="assignDeliveryModal" tabindex="-1" aria-labelledby="assignDeliveryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="assignDeliveryModalLabel">Assigner un livreur</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
        </div>
        <div class="modal-body">
          <p>Commande #{{ selectedCommande?.id }} - {{ selectedCommande?.client_name }}</p>
          <div class="mb-3">
            <label for="deliveryUser" class="form-label">Choisir un livreur</label>
            <select class="form-select" id="deliveryUser" [(ngModel)]="selectedDeliveryUser">
              <option value="">Sélectionner un livreur</option>
              <option *ngFor="let user of deliveryUsers" [value]="user.id">
                {{ user.nom }} ({{ user.email }})
              </option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="button" class="btn btn-primary" (click)="assignDelivery()" [disabled]="!selectedDeliveryUser">
            Assigner
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Bootstrap pour l'adresse complète -->
  <div class="modal fade" id="adresseModal" tabindex="-1" aria-labelledby="adresseModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="adresseModalLabel">Adresse complète</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
        </div>
        <div class="modal-body">
          <p>{{ adresseComplete }}</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
        </div>
      </div>
    </div>
  </div>



