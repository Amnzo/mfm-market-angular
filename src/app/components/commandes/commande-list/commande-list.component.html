<style>
  .btn-details {
  background: none;
  border: none;
  cursor: pointer;
  padding: 5px;
}

.btn-details i {
  font-size: 1.2rem;
}

  /* Carte */
.card {
  border-radius: 8px;
  box-shadow: 0 0 8px rgb(0 0 0 / 0.1);
  transition: transform 0.2s ease-in-out;
}

.card:hover {
  transform: translateY(-5px);
}

/* Statut de la commande */
.card-status {
  padding: 0.3rem 0.6rem;
  border-radius: 0.5rem;
  font-weight: 600;
  text-transform: capitalize;
  font-size: 0.85rem;
  color: #fff;
}

/* Couleurs selon le statut */
.status-en-attente { background-color: #8c888b; }  /* jaune */
.status-en-cours { background-color: #f00dd2; }   /* bleu clair */
.status-livrÃ©e { background-color: #198754; }     /* vert */
.status-annulÃ©e { background-color: #dc3545; }    /* rouge */


/* Bouton dÃ©tails */
.btn-details {
  background-color: transparent;
  border: none;
  color: white;
  font-size: 1.1rem;
  cursor: pointer;
  transition: color 0.2s ease-in-out;
}

.btn-details:hover {
  color: #ffc107;
}

/* Adresse tronquÃ©e (clicable) */
.adresse-tronquee {
  cursor: pointer;
  color: #0d6efd;
  text-decoration: underline;
  user-select: none;
}

/* Texte pour crÃ©dit en rouge si > 0 */
.credit-attention {
  color: #dc3545;
  font-weight: 700;
}

/* Icones crÃ©ateur et livreur */
.info-creator i,
.info-delivery i {
  margin-right: 0.4rem;
  color: #6c757d;
}

/* Blocs de dÃ©tails */
.info-block,
.products-block,
.payments-block {
  margin-bottom: 1.5rem;
  padding: 1rem;
  background-color: #f8f9fa;
  border-radius: 8px;
}

.products-block ul,
.payments-block ul {
  margin-bottom: 0;
}

.payments-block li {
  font-size: 0.9rem;
  color: #6c757d;
}

.modal-content {
  border-radius: 1rem;
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
}

.modal-header {
  background-color: #0d6efd;
  color: white;
  padding: 1.5rem;
  border-radius: 1rem 1rem 0 0 !important;
}

.modal-title {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.modal-body {
  padding: 2rem;
}

.table thead th {
  background-color: #f8f9fa;
  font-weight: 600;
  color: #495057;
}

.table td {
  vertical-align: middle;
}

/* Paiements styles */
.paiements-section {
  background-color: white;
  border-radius: 8px;
  padding: 1.5rem;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.paiement-date {
  color: #6c757d;
  font-size: 0.9rem;
}

.paiement-amount {
  font-weight: 600;
  color: #212529;
}

.paiement-method {
  color: #6c757d;
  font-size: 0.9rem;
}

/* Statut styles */
.card-status {
  padding: 0.5rem 1rem;
  border-radius: 20px;
  font-weight: bold;
  display: inline-block;
  color: #fff;
  font-size: 0.9rem;
  min-width: 120px;
  text-align: center;
}

.status-livrÃ©e {
  background-color: #198754;
  color: white;
}

.status-en-cours {
  background-color: #ffc107;
  color: #000;
}

.status-annulÃ©e {
  background-color: #dc3545;
  color: white;
}

/* Footer styles */
.modal-footer {
  padding: 1rem;
  border-top: 1px solid #dee2e6;
  background-color: #f8f9fa;
}

.btn-close-white {
  filter: brightness(0) invert(1);
}

</style>
<div class="container">
  <app-menu></app-menu>
  <div class="container-fluid bg-light rounded-3 p-4 mb-4">
    <div class="row">
      <div class="col-12">
        <h2 class="mb-3">Liste des Commandes</h2>
      </div>
    </div>
    <div class="row">
      <div class="col-12">
        <div class="input-group mb-3">
          <span class="input-group-text bg-white border-end-0">
            <i class="fas fa-search"></i>
          </span>
          <input type="text" class="form-control border-start-0" placeholder="Rechercher par nom de client..." [(ngModel)]="searchTerm" (input)="applyFilters()">
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-12 col-md-6">
        <select class="form-select form-select-sm" [(ngModel)]="statusFilter" (change)="applyFilters()">
          <option value="">Tous les statuts</option>
          <option value="en attente">En attente</option>
          <option value="en cours">En cours</option>
          <option value="livrÃ©e">LivrÃ©e</option>
          <option value="annulÃ©e">AnnulÃ©e</option>
        </select>
      </div>
      <div class="col-12 col-md-4">
        <input type="date" class="form-control form-control-sm" [(ngModel)]="dateFilter" (change)="applyFilters()">
      </div>
      <div class="col-12 col-md-2">
        <button class="btn btn-outline-primary btn-sm" (click)="creditFilter = !creditFilter; applyFilters()">
          <i class="fas fa-credit-card"></i>
          <span *ngIf="!creditFilter">Avec crÃ©dit</span>
          <span *ngIf="creditFilter">Tous</span>
        </button>
      </div>
    </div>
  </div>
  
  <!-- Liste commandes -->



<!-- Liste commandes -->
<div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
  <div class="col" *ngFor="let commande of filteredCommandes">
    <div class="card h-100 border-primary shadow-sm">
      <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">Commande #{{ commande.id }}</h5>
        <div class="d-flex align-items-center gap-2">
          <button class="btn btn-outline-light btn-sm" (click)="editCommande(commande)">
            <i class="fas fa-edit"></i>
          </button>
          <span
            class="card-status"
            [ngClass]="'status-' + commande.status.replace(' ', '-')"
          >
            {{ commande.status }}
          </span>

          <button 
            *ngIf="commande.credit_sur_commande > 0" 
            type="button" 
            class="btn btn-link text-warning p-0 m-0"
            (click)="ouvrirModalReglement(commande)"
            title="RÃ¨gler le crÃ©dit"
            data-bs-toggle="modal" 
            data-bs-target="#reglementCreditModal"
          >
            <i class="fas fa-exclamation-triangle"></i>
          </button>


          <button 
            type="button" 
            class="btn-details" 
            data-bs-toggle="modal" 
            data-bs-target="#detailsModal"
            (click)="selectedCommande = commande; loadCommandesCredit(commande.client_id)"
            title="Voir dÃ©tails"
          >
            <i class="fas fa-eye"></i>
          </button>

          <button 
            *ngIf="!commande.delivery_name && commande.status.toLowerCase() !== 'annulÃ©e'"
            type="button" 
            class="btn-details" 
            data-bs-toggle="modal" 
            data-bs-target="#assignDeliveryModal"
            (click)="selectedCommande = commande"
            title="Attribuer un livreur"
          >
            <i class="fas fa-truck"></i>
          </button>

          <button 
            type="button"
            class="btn-details"
            (click)="imprimerCommande(commande)"
            title="Imprimer la commande"
          >
            <i class="fas fa-print"></i>
          </button>

                  <!-- ğŸ†• Bouton Annuler avec modale -->
          
          <button *ngIf="commande.status.toLowerCase()=== 'en cours' || commande.status.toLowerCase() === 'en attente'"
          type="button"
          class="btn-details text-danger"
          data-bs-toggle="modal"
          [attr.data-bs-target]="'#annulerModal' + commande.id"
          title="Annuler la commande">
          <i class="fas fa-times-circle"></i>
          </button>

        </div>
      </div>

      <div class="card-body">
        <p><strong>Client :</strong> {{ commande.client_name }}</p>
        <p><strong>TÃ©lÃ©phone :</strong> {{ commande.client_mobile }}</p>
        <p>
          <strong>Adresse :</strong>
          <span
            class="adresse-tronquee"
            data-bs-toggle="modal"
            data-bs-target="#adresseModal"
            (click)="adresseComplete = commande.client_adresse"
            title="Cliquer pour voir l'adresse complÃ¨te"
          >
            {{ commande.client_adresse.length > 40 ? (commande.client_adresse | slice:0:40) + '...' : commande.client_adresse }}
          </span>
        </p>
        <p><strong>Date :</strong> {{ commande.created_at | date:'mediumDate' }}</p>
        <p><strong>Total :</strong> {{ commande.total }} DH</p>

        <p *ngIf="commande.creator_name" class="info-creator">
          <i class="fas fa-user"></i> CrÃ©Ã© par : {{ commande.creator_name }}
        </p>
        <p *ngIf="commande.status.toLowerCase() === 'livrÃ©e' && commande.delivery_name" class="info-delivery">
          <i class="fas fa-truck"></i> LivrÃ© par : {{ commande.delivery_name }}
        </p>
      </div>
    </div>

    <!-- ğŸ†• Modale de confirmation pour annuler la commande -->
    <div
      class="modal fade"
      [id]="'annulerModal' + commande.id"
      tabindex="-1"
      aria-labelledby="annulerModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title" id="annulerModalLabel">Confirmer l'annulation</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
          </div>
          <div class="modal-body">
            Voulez-vous vraiment annuler la commande <strong>#{{ commande.id }}</strong> ?
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Non</button>
            <button
              type="button"
              class="btn btn-danger"
              (click)="annulerCommande(commande); closeModal('annulerModal' + commande.id)"
            >
              Oui, annuler
            </button>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>


  <!-- Modals -->
  <!-- Modals -->
<div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white rounded-top">
        <h5 class="modal-title" id="detailsModalLabel">
          <i class="fas fa-info-circle me-2"></i>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ #{{ selectedCommande?.id }}
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body">
        <div class="row mb-4">
          <div class="col-md-6">
            <p><strong><i class="fas fa-user me-1"></i>Ø§Ù„Ø¹Ù…ÙŠÙ„ :</strong> {{ selectedCommande?.client_name }}</p>
            <p><strong><i class="fas fa-phone me-1"></i>Ø§Ù„Ù‡Ø§ØªÙ :</strong> {{ selectedCommande?.client_mobile }}</p>
            <p><strong><i class="fas fa-map-marker-alt me-1"></i>Ø§Ù„Ø¹Ù†ÙˆØ§Ù† :</strong> {{ selectedCommande?.client_adresse }}</p>
            <p><strong><i class="fas fa-calendar-alt me-1"></i>Ø§Ù„ØªØ§Ø±ÙŠØ® :</strong> {{ selectedCommande?.created_at | date:'medium' }}</p>
            <p><strong><i class="fas fa-coins me-1"></i>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ :</strong> {{ selectedCommande?.total | number:'1.2-2' }} </p>
            <div *ngIf="selectedCommande?.credit_sur_commande" class="alert alert-warning p-2 mb-3">
              <div class="d-flex align-items-center">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <div>
                  <strong>Ø§Ù„Ø¯ÙŠÙ† Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ :</strong> 
                  <span class="credit-attention">{{ selectedCommande?.credit_sur_commande | number:'1.2-2' }} DH</span>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <p><strong><i class="fas fa-info-circle me-1"></i>Statut :</strong>
              <span class="card-status status-{{ selectedCommande?.status.replace(' ', '-').toLowerCase() }}">
                {{ selectedCommande?.status }}
              </span>
            </p>
            <p *ngIf="selectedCommande?.delivery_name" class="info-delivery">
              <i class="fas fa-truck me-2"></i>
              <span *ngIf="selectedCommande?.status.toLowerCase() === 'livrÃ©e'">LivrÃ© par :</span>
              <span *ngIf="selectedCommande?.status.toLowerCase() === 'en cours'">AttribuÃ© Ã  :</span>
              {{ selectedCommande?.delivery_name }}
            </p>
          </div>
        </div>

        <!-- Produits -->
        <div class="mb-4">
          <h5 class="text-primary border-bottom pb-2 mb-3">
            <i class="fas fa-boxes me-2"></i>Produits
          </h5>
          <div class="table-responsive">
            <table class="table table-sm table-striped align-middle">
              <thead>
                <tr>
                  <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
                  <th>Ø§Ù„Ø³Ø¹Ø±</th>
                  <th>Ø§Ù„Ø®ØµÙ…</th>
                  <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                  <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of selectedCommande?.items">
                  <td>{{ item.product_name }}</td>
                  <td>{{ item.price | number:'1.2-2' }} </td>
                  <td>{{ item.remise }} </td>
                  <td>{{ item.quantity }}</td>
                  <td>{{ item.total_ligne | number:'1.2-2' }} </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Commandes avec crÃ©dit -->
        <div class="commandes-credit-section" *ngIf="commandesCredit?.length > 0">
          <h5 class="text-primary border-bottom pb-2 mb-3">
            <i class="fas fa-history me-2"></i>Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù…Ø¹ Ø§Ù„Ø¯ÙŠÙˆÙ†
          </h5>
          <div class="table-responsive">
            <table class="table table-sm table-striped align-middle">
              <thead>
                <tr>
                  <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                  <th>Ø§Ù„ØºÙ„Ù‚</th>
                  <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th>
                  <th>Ø§Ù„Ø¯ÙŠÙ†</th>
                  <th>Ø§Ù„Ø¨Ø§Ø¦Ø¹</th>
                  <th>Ø§Ù„Ø³Ø§Ø¦Ù‚</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let cmd of commandesCredit">
                  <td>{{ cmd.created_at | date:'dd-MM-yyyy' }}</td>
                  <td>{{ cmd.cloture_date | date:'dd-MM-yyyy' }}</td>
                  <td>{{ cmd.total | number:'1.2-2' }}</td>
                  <td>{{ cmd.credit_sur_commande | number:'1.2-2' }}</td>
                  <td>{{ cmd.vendeur }}</td>
                  <td>{{ cmd.livreur }}</td>
                </tr>
                <tr>
                  <td colspan="3" class="text-end fw-bold">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙŠÙˆÙ† :</td>
                  <td class="fw-bold">{{ sommeCredits() | number:'1.2-2' }}</td>
                  <td colspan="2"></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Paiements -->
        <div class="paiements-section" *ngIf="selectedCommande?.paiements?.length > 0">
          <h5 class="text-primary border-bottom pb-2 mb-3">
            <i class="fas fa-money-bill-wave me-2"></i>Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª
          </h5>
          <div class="table-responsive">
            <table class="table table-sm table-striped align-middle">
              <thead>
                <tr>
                  <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                  <th class="text-end">Ø§Ù„Ù…Ø¨Ù„Øº</th>
                  <th>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</th>
                  <th>ØªØ¹Ù„ÙŠÙ‚</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let paiement of selectedCommande?.paiements">
                  <td class="paiement-date">
                    <i class="fas fa-calendar-alt me-1"></i>
                    {{ paiement.date_paiement | date:'medium' }}
                  </td>
                  <td class="text-end paiement-amount">
                    <i class="fas fa-money-bill-wave me-1"></i>
                    {{ paiement.montant | number:'1.2-2' }} 
           
                  </td>
                  <td class="paiement-method">
                    <i class="fas fa-credit-card me-1"></i>
                    {{ paiement.mode_paiement }}
                  </td>
                  <td>{{paiement.commentaire}}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times me-1"></i> Fermer
        </button>
      </div>
    </div>
  </div>
</div>

  <!-- Modal pour rÃ¨glement du crÃ©dit -->
  <div class="modal fade" id="reglementCreditModal" tabindex="-1" aria-labelledby="reglementCreditModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white rounded-top">
          <h5 class="modal-title" id="reglementCreditModalLabel">
            
            <i class="fas fa-money-bill-wave me-2"></i>RÃ¨glement du crÃ©dit - Commande #{{ selectedCommande?.id }}
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Montant Ã  payer</label>
            <div class="input-group">
              <span class="input-group-text">DH</span>
              <input type="number" class="form-control" [(ngModel)]="montantPaiement" 
                     [min]="0" [max]="selectedCommande?.credit_sur_commande" 
                     placeholder="Montant du paiement">
            </div>
            <small class="text-muted">CrÃ©dit restant : {{ selectedCommande?.credit_sur_commande | number:'1.2-2' }} DH</small>
          </div>

          <div class="mb-3">
            <label class="form-label">Commentaires</label>
            <textarea required class="form-control" [(ngModel)]="commentairePaiement" 
                      placeholder="DÃ©tails du paiement (ex: virement, espÃ¨ces, etc.)" 
                      rows="3"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times me-1"></i>Annuler
          </button>
          <button type="button" class="btn btn-primary" (click)="validerPaiement()">
            <i class="fas fa-check me-1"></i>Valider le paiement
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal pour assigner un livreur -->
  <div class="modal fade" id="assignDeliveryModal" tabindex="-1" aria-labelledby="assignDeliveryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="assignDeliveryModalLabel">Assigner un livreur</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
        </div>
        <div class="modal-body">
          <p>Commande #{{ selectedCommande?.id }} - {{ selectedCommande?.client_name }}</p>
          <div class="mb-3">
            <label for="deliveryUser" class="form-label">Choisir un livreur</label>
            <select class="form-select" id="deliveryUser" [(ngModel)]="selectedDeliveryUser">
              <option value="">SÃ©lectionner un livreur</option>
              <option *ngFor="let user of deliveryUsers" [value]="user.id">
                {{ user.nom }} ({{ user.email }})
              </option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="button" class="btn btn-primary" (click)="assignDelivery()" [disabled]="!selectedDeliveryUser">
            Assigner
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Bootstrap pour l'adresse complÃ¨te -->
  <div class="modal fade" id="adresseModal" tabindex="-1" aria-labelledby="adresseModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="adresseModalLabel">Adresse complÃ¨te</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
        </div>
        <div class="modal-body">
          <p>{{ adresseComplete }}</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
        </div>
      </div>
    </div>
  </div>



